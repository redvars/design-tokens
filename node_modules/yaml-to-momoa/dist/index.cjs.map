{"version":3,"file":"index.cjs","sources":["../src/transform.ts","../src/index.ts"],"sourcesContent":["import type {\n  ArrayNode,\n  BooleanNode,\n  NullNode,\n  NumberNode,\n  ObjectNode,\n  StringNode,\n  ValueNode,\n} from \"@humanwhocodes/momoa\";\nimport { Alias, type Document, type Range, Scalar, YAMLMap, YAMLSeq } from \"yaml\";\n\n// yaml types are way too generic and allow for silliness; this is a more practical subset\nexport type YAMLNode = Alias | Scalar | YAMLMap<Scalar, YAMLNode> | YAMLSeq<YAMLNode>;\n\ninterface TransformOptions {\n  /** Convert YAML range to Momoa Loc */\n  transformRange: (range?: Range | null | undefined) => ValueNode[\"loc\"];\n  /** YAML document */\n  doc: Document;\n}\n\nexport function transform(node: YAMLNode | null | undefined, { doc, transformRange }: TransformOptions): ValueNode {\n  const nullNode: NullNode = {\n    type: \"Null\",\n    loc: transformRange(node?.range),\n  };\n\n  if (node instanceof YAMLMap) {\n    return transformYAMLMap(node, { doc, transformRange });\n  }\n  if (node instanceof YAMLSeq) {\n    return transformYAMLSeq(node, { doc, transformRange });\n  }\n  if (node instanceof Scalar) {\n    return transformScalar(node, { doc, transformRange });\n  }\n  if (node instanceof Alias) {\n    const resolved = node.resolve(doc);\n    if (resolved) {\n      const cloned = resolved.clone() as YAMLNode;\n      // try and use base range. even though it won’t match, it will at least\n      // mark the start correctly\n      cloned.range = node.range ?? cloned.range;\n      return transform(cloned, { doc, transformRange });\n    }\n    return nullNode;\n  }\n  return nullNode;\n}\n\nexport function transformYAMLMap(\n  node: YAMLMap<Scalar, YAMLNode>,\n  { doc, transformRange }: TransformOptions,\n): ObjectNode {\n  return {\n    type: \"Object\",\n    members: node.items.map((item) => ({\n      type: \"Member\",\n      name: transform(item.key, { doc, transformRange }) as StringNode,\n      value: transform(item.value, { doc, transformRange }),\n      loc: transformRange([item.key.range?.[0] ?? -1, item.value?.range?.[1] ?? -1, item.value?.range?.[2] ?? -1]), // note: the YAML parser doesn’t keep a range on the item itself; use its children instead\n    })),\n    loc: transformRange(node.range),\n  };\n}\n\nexport function transformYAMLSeq(node: YAMLSeq<YAMLNode>, { doc, transformRange }: TransformOptions): ArrayNode {\n  return {\n    type: \"Array\",\n    elements: node.items.map((item) => ({\n      type: \"Element\",\n      value: transform(item, { doc, transformRange }),\n      loc: transformRange(item.range),\n    })),\n    loc: transformRange(node.range),\n  };\n}\n\nexport function transformScalar(\n  node: Scalar,\n  { transformRange }: TransformOptions,\n): StringNode | BooleanNode | NumberNode | NullNode {\n  switch (typeof node.value) {\n    case \"string\": {\n      return {\n        type: \"String\",\n        value: node.value,\n        loc: transformRange(node.range),\n      };\n    }\n    case \"boolean\": {\n      return {\n        type: \"Boolean\",\n        value: node.value,\n        loc: transformRange(node.range),\n      };\n    }\n    case \"number\": {\n      return {\n        type: \"Number\",\n        value: node.value,\n        loc: transformRange(node.range),\n      };\n    }\n  }\n\n  if (node.value === null) {\n    return {\n      type: \"Null\",\n      loc: transformRange(node.range),\n    };\n  }\n\n  throw new Error(`Unexpected scalar value: ${node.value}`);\n}\n","import type { AnyNode, DocumentNode } from \"@humanwhocodes/momoa\";\nimport { LineCounter, type Range, parseDocument } from \"yaml\";\nimport { type YAMLNode, transform } from \"./transform.js\";\n\nexport default function yamlToMomoa(yaml: string, parseOptions?: Parameters<typeof parseDocument>[1]): DocumentNode {\n  const doc = parseDocument(yaml, {\n    lineCounter: new LineCounter(),\n    keepSourceTokens: true,\n    ...parseOptions,\n  });\n\n  if (doc.errors?.length) {\n    for (const error of doc.errors) {\n      throw error;\n    }\n  }\n  if (!doc.contents) {\n    throw new Error(\"YAML content null\");\n  }\n\n  // build sourcemap locations\n  const locMap = new Map<number, { line: number; column: number }>();\n  let line = 1;\n  let column = 0; // this starts at 1, but we increment it before counting\n  for (let i = 0; i <= yaml.length; i++) {\n    if (yaml[i] === \"\\n\") {\n      line++;\n      column = 1;\n    } else {\n      column++;\n    }\n    locMap.set(i, { line, column });\n  }\n  function transformRange(range: Range | null | undefined): AnyNode[\"loc\"] {\n    let [startOffset, endOffset] = range ?? [-1, 0];\n    endOffset--; // endOffset is inclusive, so decrement by 1\n    const start = locMap.get(startOffset) ?? { line: -1, column: -1 };\n    const end = locMap.get(endOffset) ?? { line: -1, column: -1 };\n    return { start: { ...start, offset: startOffset }, end: { ...end, offset: endOffset } };\n  }\n\n  // transform\n  const body = transform(doc.contents as YAMLNode, {\n    doc,\n    transformRange,\n  });\n\n  const docEnd = locMap.get(yaml.length - 1) ?? { line: -1, column: -1 };\n  return {\n    type: \"Document\",\n    body,\n    loc: { start: { line: 1, column: 1, offset: 0 }, end: { ...docEnd, offset: yaml.length - 1 } },\n  };\n}\n"],"names":["YAMLMap","YAMLSeq","Scalar","Alias","yaml","parseDocument","LineCounter"],"mappings":"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"}